{
  "version": 3,
  "sources": ["../src/effect.ts", "../src/system.ts", "../src/ref.ts"],
  "sourcesContent": ["import { Link } from \"./system\"\r\n\r\nexport let activeSub\r\n\r\nclass ReactiveEffect {\r\n    constructor(public fn) {\r\n\r\n    }\r\n    // \u4F9D\u8D56\u9879\u5217\u8868\u7684\u5934\u8282\u70B9\r\n    deps: Link | undefined\r\n    // \u4F9D\u8D56\u9879\u5217\u8868\u7684\u5C3E\u8282\u70B9\r\n    depsTail: Link | undefined\r\n\r\n    run() {\r\n        // \u5148\u5C06\u4E4B\u524D\u7684effect\u4FDD\u5B58\u8D77\u6765  \u6CA1\u6709\u5D4C\u5957\u65F6\u5019\u5C31\u662Fundefined,\u56E0\u4E3Ajs\u662F\u5355\u7EBF\u7A0B\u7684 \u6240\u4EE5\u53EA\u6709\u4E00\u4E2AactiveSub  \u4E0A\u4E0B\u4E24\u4E2Aeffect\u4E5F\u4E0D\u5F71\u54CD\r\n        const prevSub = activeSub\r\n        activeSub = this\r\n        startTrack(this)\r\n        try {\r\n            return this.fn()\r\n        } finally {\r\n            endTrack(this)\r\n            // if (this.depsTail) {\r\n            //     console.log('\u6E05\u7406', this.depsTail.nextDep);\r\n            // }\r\n            // \u6062\u590D\u4E4B\u524D\u7684effect\r\n            activeSub = prevSub\r\n        }\r\n    }\r\n    // \u4F9D\u8D56\u7684\u6570\u636E\u53D1\u751F\u4E86\u53D8\u5316 \u4F1A\u8C03\u7528notify\r\n    notify() {\r\n        this.scheduler()\r\n    }\r\n    // scheduler \u6709\u53EF\u80FD\u4F1A\u88AB\u5916\u90E8\u4F20\u5165\u7684options\u8986\u76D6\r\n    scheduler() {\r\n        // \u5728scheduler\u4E2D\u6267\u884Crun\u65B9\u6CD5\r\n        this.run()\r\n    }\r\n}\r\n// \u5F00\u59CB\u8FFD\u8E2A\u4F9D\u8D56\r\nfunction startTrack(sub) {\r\n    sub.depsTail = undefined\r\n}\r\n// \u7ED3\u675F\u8FFD\u8E2A \u6E05\u7406\u4F9D\u8D56\r\nfunction endTrack(sub) {\r\n    const depsTail = sub.depsTail\r\n    if (depsTail) {\r\n        if (depsTail.nextDep) {\r\n            console.log('\u5982\u679C\u5C3E\u8282\u70B9\u8FD8\u6709\u4E0B\u4E00\u4E2A\u8282\u70B9\uFF0C\u8BF4\u660E\u7B2C\u4E8C\u6B21effect\u6267\u884C\u65F6 \u6709\u7684ref\u5C1D\u8BD5\u590D\u7528\u6536\u96C6\u8FC7\u7684\u8282\u70B9\u3002\u590D\u7528\u5931\u8D25\u4E86 \u6B64\u65F6\u8FD9\u4E2A\u5931\u8D25\u7684\u5C31\u662F\u6CA1\u88AB\u4E8C\u6B21\u4F9D\u8D56\u6536\u96C6\u7684\u8282\u70B9\u6240\u4EE5\u8981\u6E05\u7406');\r\n            clearTracking(depsTail.nextDep)\r\n            depsTail.nextDep = undefined\r\n        }\r\n    } else if (sub.deps) {\r\n        // \u56E0\u4E3A\u9996\u6B21effect\u6267\u884C\u628A\u5C3E\u7ED3\u70B9\u5F04\u4E3Aundefined\u4E86\uFF0C\u5982\u679C\u4E8C\u6B21\u6267\u884C\u65F6\u8FD8\u662Fundefined\u8BF4\u660E\u4F9D\u8D56\u6CA1\u6536\u96C6\u5230\uFF08\u6240\u6709\u7684ref\u90FD\u6CA1\u8FDBif\uFF09\r\n        // \u6240\u4EE5\u6CA1\u8FDBif\u8981\u628Adeps\u5168\u90E8\u5220\u6389 \u5934\u8282\u70B9\u662F\u7B2C\u4E00\u6B21\u6536\u96C6\u7684\r\n        clearTracking(sub.deps)\r\n        sub.deps = undefined\r\n    }\r\n}\r\n//\u4F9D\u8D56\u6E05\u7406\uFF1A\u8981\u5220\u9664dep\u6536\u96C6\u4F9D\u8D56\u65F6\u7684\u5404\u4E2Alink\u8282\u70B9 \u6700\u540E\u5C31\u662F\u5220\u9664\u4E86dep\u7684\u4F9D\u8D56 \r\nfunction clearTracking(link: Link) {\r\n    while (link) {\r\n        const { sub, prevSub, nextSub, nextDep, dep } = link\r\n        // \u5982\u679C\u4E0A\u4E00\u4E2A\u8282\u70B9\u6709\uFF0C\u5C31\u628A\u4E0A\u4E00\u4E2A\u8282\u70B9\u7684\u4E0B\u4E00\u4E2A\u6307\u5411\u8981\u6E05\u7406\u7684\u4E0B\u4E00\u4E2A  \u573A\u666F \u4E00\u4E2Aname\u88AB\u4E24\u4E2Aeffect\u5F15\u5165 \u7B2C\u4E00\u4E2Aeffect\u5982\u679C\u8981\u6E05\u7406 \u8FD8\u8981\u628A\u540E\u9762\u7684effect\u5173\u7CFB\u5904\u7406\u4E00\u4E0B\r\n        if (prevSub) {\r\n            prevSub.nextSub = nextSub\r\n            link.nextDep = undefined\r\n        } else {\r\n            // \u6CA1\u6709\u4E0A\u4E00\u4E2A\u8BF4\u660E\u662F\u5934\u8282\u70B9\uFF0C\u628A\u5934\u7ED3\u70B9\u6307\u5411\u8981\u6E05\u7406\u7684\u4E0B\u4E00\u4E2A,\u8FD9\u4E2A\u4F9D\u8D56\u6E05\u7406\u4E86 \u6240\u4EE5\u8981\u65AD\u5F00dep ref\u4E2D\u7684subs\u5173\u8054\u5F53\u524D\u8282\u70B9\r\n            dep.subs = nextSub\r\n        }\r\n        if (nextSub) {\r\n            // \u5982\u679C\u6709\u4E0B\u4E00\u4E2A\u8282\u70B9\uFF0C\u628A\u4E0B\u4E00\u4E2A\u8282\u70B9\u7684\u4E0A\u4E00\u4E2A\u6307\u5411\u8981\u6E05\u7406\u7684\u4E0A\u4E00\u4E2A\r\n            nextSub.prevSub = prevSub\r\n            link.prevSub = undefined\r\n        } else {\r\n            // \u6CA1\u6709\u4E0B\u4E00\u4E2A\u8282\u70B9\u8BF4\u660E\u662F\u5C3E\u8282\u70B9\uFF0C\u628A\u5C3E\u8282\u70B9\u6307\u5411\u8981\u6E05\u7406\u7684\u4E0A\u4E00\u4E2A\r\n            dep.subsTail = prevSub\r\n        }\r\n        // \u8282\u70B9\u6E05\u7406\u4E86  \u6240\u4EE5\u628A\u8282\u70B9\u7684dep\u548Csub\u5168\u5220\u6389\r\n        link.dep = link.sub = undefined\r\n        link.nextDep = undefined\r\n        // \u4E0B\u4E00\u8F6E\u5FAA\u73AF \u7EE7\u7EED\u6E05\u7406\r\n        link = nextDep\r\n    }\r\n}\r\nexport function effect(fn, options) {\r\n    const e = new ReactiveEffect(fn)\r\n    Object.assign(e, options)\r\n    e.run()\r\n    // const runner = () => e.run()\r\n    const runner = e.run.bind(e)  //\u5B98\u65B9\u5199\u6CD5 bind\u4E5F\u521B\u5EFA\u4E86\u4E00\u4E2A\u51FD\u6570 \u540C\u4E0A\u8FF0\u5199\u6CD5\r\n    runner.effect = e\r\n    // \u4E3A\u4E86\u4FDD\u969Cthis \u8981\u8FD4\u56DE\u4E00\u4E2A\u51FD\u6570   \u540C\u65F6\u7ED9\u51FD\u6570\u52A0\u4E2A\u5C5E\u6027 effect\r\n    return runner\r\n}", "import { ReactiveEffect } from \"vue\"\r\nimport { activeSub } from \"./effect\"\r\n// \u4F9D\u8D56\u9879  \u6709\u53EF\u80FD\u662Fref \u4E5F\u53EF\u80FD\u662Freactive     \r\n// flag count \u4F5C\u4E3Aref\u5728\u4E00\u4E2Aeffect\u4F1A\u8FDB\u884C\u4E24\u6B21\u4F9D\u8D56\u6536\u96C6\uFF0C\u521B\u5EFA\u4E24\u4E2Alink\u8282\u70B9\uFF0C\u540C\u65F6\u901A\u8FC7\u5F80 flag count\u7684dep\uFF08ref\u7684this\uFF09\u589E\u52A0subsTail\u548Csubs\u5C5E\u6027\uFF0C\u5C06activeEffect\u8FDB\u884C\u5173\u8054\uFF08\u9632\u6B62\u5D4C\u5957effect\uFF09\r\n// \u8FD9\u4E24\u4E2Alink\u8282\u70B9\u4E2D\uFF0C\u6BCF\u4E2Alink\u8282\u70B9\u4E2D \u5B58\u653Esub \uFF0Csub\u4E3Aref\u6570\u636E\u6536\u96C6\u5230\u7684activeeffect\uFF08effect\u5B9E\u4F8B\uFF09\uFF0C\r\n// \u8FD9\u4E2Aeffect\u5462\u91CC\u9762\u5B58\u653E\u4E86deps depsTail  \u5176\u5B9E\u662FactiveEffect\uFF08\u53EA\u6709\u4E00\u4E2Aeffect\uFF09\u4E0E\u5F53\u524D\u7684link1 link2\uFF0C\u5982\u679C\u53EA\u6709\u4E00\u4E2Alink\u8282\u70B9\uFF0C\u90A3\u4E48run \u7684\u65F6\u5019\u5C31\u53EF\u4EE5\u5224\u65AD effect\u4E2D\u5B58\u653E\u7684deps\uFF08\u5934\u8282\u70B9 \uFF09\u4E2D\u7684dep\u662F\u5426\u4E0E\u5F53\u524D\u7684link1 link2\u7684dep\u76F8\u540C\uFF0C\u5982\u679C\u76F8\u540C\u5219\u590D\u7528\u3002\r\n// \u5982\u679C\u6709\u4E24\u4E2Alink\u8282\u70B9\uFF0C\u6BD4\u5982 flag\u548Ccount \u4F9D\u8D56\u6536\u96C6\u7684link\u8282\u70B9\uFF0C\u90A3\u4E48\u5C31\u53D6effect\u7684depsTail \u5C3E\u8282\u70B9\u7684nextDep\u4F5C\u4E3A\u590D\u7528\u8282\u70B9\r\n//\r\ninterface Dep {\r\n    // \u8BA2\u9605\u8005\u5217\u8868 \u5934\u7ED3\u70B9\u548C\u5C3E\u8282\u70B9\r\n    subs: Link | undefined\r\n    subsTail: Link | undefined\r\n}\r\ninterface Sub {\r\n    deps: Link | undefined\r\n    depsTail: Link | undefined\r\n}\r\nexport interface Link {\r\n    sub: Sub\r\n    nextSub: Link | undefined\r\n    prevSub: Link | undefined\r\n    dep: Dep\r\n    nextDep: Link | undefined\r\n}\r\nexport function link(dep, sub) {\r\n    // \u53D6\u5F53\u524D\u7684 effect\u5B9E\u4F8B\u7684 deps\u4F9D\u8D56\u9879\u5C3E\u8282\u70B9 \u6CA1\u6709\u5C3E\u7ED3\u70B9\u65F6\u5BF9\u6BD4\u5934\u8282\u70B9\u662F\u5426\u76F8\u540C\uFF0C\u76F8\u540C\u5219\u590D\u7528\r\n    const currentDep = sub.depsTail\r\n    // \u53EF\u4EE5\u590D\u7528\u7684\u8282\u70B9\r\n    const nextDep = currentDep === undefined ? sub.deps : currentDep.nextDep\r\n    if (nextDep && nextDep.dep === dep) {\r\n        sub.depsTail = nextDep\r\n        return\r\n    }\r\n    const newLink = {\r\n        sub,\r\n        dep,\r\n        nextDep,\r\n        nextSub: undefined,\r\n        prevSub: undefined\r\n    }\r\n    // \u5C06\u4FDD\u5B58\u4E86\u5F53\u524Deffect\u4F9D\u8D56\u7684\u8282\u70B9\uFF0C\u6DFB\u52A0\u5230\u53CC\u5411\u94FE\u8868\r\n    if (dep.subsTail) {\r\n        // \u5982\u679C\u6709\u5C3E\u8282\u70B9 \u5C06\u5C3E\u8282\u70B9\u7684next\u6307\u5411\u65B0\u8282\u70B9 \u5C06\u65B0\u8282\u70B9\u7684prev\u6307\u5411\u5C3E\u8282\u70B9 \u5C06\u5C3E\u8282\u70B9\u6307\u9488\u6307\u5411\u65B0\u8282\u70B9\r\n        dep.subsTail.nextSub = newLink\r\n        newLink.prevSub = dep.subsTail\r\n        dep.subsTail = newLink\r\n    } else {\r\n        dep.subs = newLink\r\n        dep.subsTail = newLink\r\n    }\r\n\r\n    // \u5C06\u94FE\u8868\u8282\u70B9\u548Cdep\u5EFA\u7ACB\u5173\u8054\u5173\u7CFB\r\n    if (sub.depsTail) {\r\n        sub.depsTail.nextDep = newLink\r\n        sub.depsTail = newLink\r\n    } else {\r\n        sub.deps = newLink\r\n        sub.depsTail = newLink\r\n    }\r\n}\r\n// \u6536\u96C6\u4F9D\u8D56  \r\nexport function trackRef(dep) {\r\n    if (activeSub) {\r\n        link(dep, activeSub)\r\n    }\r\n}\r\n// \u89E6\u53D1ref\u5173\u8054\u7684effect\u91CD\u65B0\u6267\u884C\r\nexport function triggerRef(dep) {\r\n    // \u94FE\u8868\u5934\u8282\u70B9\r\n    if (dep.subs) {\r\n        propagete(dep.subs)\r\n    }\r\n}\r\nfunction propagete(subs) {\r\n    let link = subs\r\n    const queueEffect = []\r\n    while (link) {\r\n        queueEffect.push(link.sub)\r\n        link = link.nextSub\r\n    }\r\n    queueEffect.forEach(effect => effect.notify())\r\n}", "import { Link, trackRef, triggerRef } from \"./system\";\r\n\r\nenum ReactiveFlags {\r\n    IS_REF = '__v_isRef'\r\n}\r\n// \u94FE\u8868\u8282\u70B9\r\n\r\n\r\nclass RefImpl {\r\n    _value\r\n    [ReactiveFlags.IS_REF] = true // \u6807\u8BC6\r\n    subs: Link   //subscribers(\u8BA2\u9605\u8005) \u6B64\u5904\u5B58\u50A8\u5F53\u524D\u4F9D\u8D56\u7684\u526F\u4F5C\u7528\u51FD\u6570effect\r\n    // \u5C3E\u8282\u70B9\r\n    subsTail: Link\r\n    constructor(value) {\r\n        this._value = value\r\n    }\r\n    get value() {\r\n        // \u6536\u96C6\u4F9D\u8D56\r\n        trackRef(this)\r\n        return this._value\r\n    }\r\n    set value(newValue) {\r\n        this._value = newValue\r\n        triggerRef(this)\r\n    }\r\n}\r\n\r\nexport function ref(value) {\r\n    return new RefImpl(value)\r\n}\r\nexport function isRef(value) {\r\n    return !!(value && value[ReactiveFlags.IS_REF])\r\n} "],
  "mappings": "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",
  "names": ["link", "link", "effect"]
}
